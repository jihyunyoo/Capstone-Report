<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.CommentMapper">

  <resultMap id="CommentMap" type="com.example.demo.model.Comment">
    <id     column="ID"         property="id"/>
    <result column="POST_ID"    property="postId"/>
    <result column="AUTHOR"     property="author"/>
    <result column="CONTENT"    property="content"/>
    <result column="CREATED_AT" property="createdAt"/>
    <result column="PARENT_ID"  property="parentId"/>
  </resultMap>

  <!-- 게시글별 댓글 목록 (페이지네이션) -->
  <select id="listByPost" resultMap="CommentMap">
    SELECT *
    FROM (
      SELECT a.*, ROWNUM rn
      FROM (
        SELECT ID, POST_ID, AUTHOR, CONTENT, CREATED_AT, PARENT_ID
        FROM COMMENTS
        WHERE POST_ID = #{postId}
        ORDER BY CREATED_AT DESC
      ) a
      WHERE ROWNUM &lt;= #{offset} + #{limit}
    )
    WHERE rn &gt; #{offset}
  </select>

  <!-- 댓글 단건 조회 -->
  <select id="findById" resultMap="CommentMap">
    SELECT ID, POST_ID, AUTHOR, CONTENT, CREATED_AT, PARENT_ID
    FROM COMMENTS
    WHERE ID = #{id}
  </select>

  <!-- 댓글 등록: 시퀀스 + PARENT_ID NULL 허용 -->
  <insert id="insert" parameterType="com.example.demo.model.Comment">
    <selectKey keyProperty="id" resultType="long" order="BEFORE">
      SELECT SEQ_COMMENTS.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO COMMENTS (ID, POST_ID, AUTHOR, CONTENT, CREATED_AT, PARENT_ID)
    VALUES (
      #{id},
      #{postId},
      #{author},
      #{content},
      SYSTIMESTAMP,
      #{parentId, jdbcType=NUMERIC}
    )
  </insert>

  <!-- 댓글 삭제(게시글 검증 포함) -->
  <delete id="deleteByIdAndPostId">
    DELETE FROM COMMENTS WHERE ID = #{id} AND POST_ID = #{postId}
  </delete>

  <!-- 공개 삭제(id만) -->
  <delete id="deleteById">
    DELETE FROM COMMENTS WHERE ID = #{id}
  </delete>

</mapper>
